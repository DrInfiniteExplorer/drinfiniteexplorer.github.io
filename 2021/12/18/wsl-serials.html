
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WSL2 & USB Serials - Siffer</title>
    <link rel="stylesheet" href="/assets/css/app.css">
    <link rel="shortcut icon" type="image/png"
           href="/favicon.png" 
    />
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>WSL2 &amp; USB Serials | Siffer</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="WSL2 &amp; USB Serials" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Yo yo! USB &amp; USB-serials in WSL? Read more!" />
<meta property="og:description" content="Yo yo! USB &amp; USB-serials in WSL? Read more!" />
<link rel="canonical" href="https://blog.luben.se/2021/12/18/wsl-serials.html" />
<meta property="og:url" content="https://blog.luben.se/2021/12/18/wsl-serials.html" />
<meta property="og:site_name" content="Siffer" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-12-18T22:40:00+01:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"https://blog.luben.se/2021/12/18/wsl-serials.html","headline":"WSL2 &amp; USB Serials","dateModified":"2021-12-18T22:40:00+01:00","datePublished":"2021-12-18T22:40:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.luben.se/2021/12/18/wsl-serials.html"},"description":"Yo yo! USB &amp; USB-serials in WSL? Read more!","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<!-- head scripts --></head>

  <body>
    
<nav class="navbar is-primary" >
    <div class="container">
        <div class="navbar-brand">
            <a href="/" class="navbar-item">
                Siffer
            </a>
            <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>
        <div class="navbar-menu" id="navMenu">
            <div class="navbar-start">
                <a href="/" class="navbar-item ">Home</a>
                
                
                    
                    <a href="/blog" class="navbar-item ">Blog</a>
                    
                
                    
                    <a href="/tags" class="navbar-item ">Tags</a>
                    
                
                    
                    <a href="/factorio" class="navbar-item ">Factorio</a>
                    
                
                
            </div>

            <div class="navbar-end">
                
            </div>

        </div>
    </div>
</nav>

    
        <section class="hero  is-small  is-bold is-primary" >
    <div class="hero-body ">
        <div class="container">
            <p class="title is-2">WSL2 & USB Serials</p>
            <p class="subtitle is-3"></p>
            
        </div>
    </div>
</section>
    
    


    <section class="section">
        <div class="container">
            <div class="columns">
                
                <div class="column is-8">
                    
                    
                    
                    <div class="content">

    <p>Published: 2021-12-18 </p>
    
<div class="tags">
    Tags:&nbsp;
    
    <a href="/tags/#blog"><span class="tag is-primary">blog</span></a>&nbsp;
    
    <a href="/tags/#WSL2"><span class="tag is-primary">WSL2</span></a>&nbsp;
    
    <a href="/tags/#usbipd-win"><span class="tag is-primary">usbipd-win</span></a>&nbsp;
    
</div>

    <p>Yo yo! USB &amp; USB-serials in WSL? Read more!</p>

<div id="toc" style="float:none">
<ul id="markdown-toc">
  <li><a href="#introductory-rambling" id="markdown-toc-introductory-rambling">Introductory rambling</a></li>
  <li><a href="#wsl-kernel-version-needs-to-be-lifted" id="markdown-toc-wsl-kernel-version-needs-to-be-lifted">WSL Kernel version needs to be lifted!</a>    <ul>
      <li><a href="#do-i-need-to-win11-or-windows-update" id="markdown-toc-do-i-need-to-win11-or-windows-update">Do I need to win11 or windows update??</a></li>
      <li><a href="#just-build-the-kernel-yourself-its-not-scary" id="markdown-toc-just-build-the-kernel-yourself-its-not-scary">Just build the kernel yourself, it’s not scary</a></li>
    </ul>
  </li>
  <li><a href="#usbipd-win" id="markdown-toc-usbipd-win">USBIPD-WIN</a>    <ul>
      <li><a href="#troubles-in-paradise" id="markdown-toc-troubles-in-paradise">Troubles in paradise</a>        <ul>
          <li><a href="#share-thy-wealth" id="markdown-toc-share-thy-wealth">Share thy wealth</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#let-wsl2-join-the-fun-or-usbip-in-wsl" id="markdown-toc-let-wsl2-join-the-fun-or-usbip-in-wsl">Let WSL2 join the fun (or: <code class="language-bash highlighter-rouge">usbip</code> in <code class="language-bash highlighter-rouge">wsl</code>)</a>    <ul>
      <li><a href="#you-cant-access-that" id="markdown-toc-you-cant-access-that">You can’t access that!</a>        <ul>
          <li><a href="#missing-udev-rules" id="markdown-toc-missing-udev-rules">Missing udev rules??</a></li>
        </ul>
      </li>
      <li><a href="#automate-wsl-udev-service-starting" id="markdown-toc-automate-wsl-udev-service-starting">Automate WSL <code class="language-bash highlighter-rouge">udev service</code> starting</a></li>
    </ul>
  </li>
  <li><a href="#the-promised-land" id="markdown-toc-the-promised-land">The promised land</a>    <ul>
      <li><a href="#automating-wsl-side-attaching" id="markdown-toc-automating-wsl-side-attaching">Automating WSL-side attaching</a>        <ul>
          <li><a href="#c" id="markdown-toc-c">C++</a></li>
          <li><a href="#python3" id="markdown-toc-python3">Python3</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
</div>

<h1 id="introductory-rambling">Introductory rambling</h1>

<p>WSL1 is supercool, as it makes ELF-binaries executable <em>straight up</em> by the windows OS.</p>

<p>WSL2 which uses slim virtual machines is not quite as <em>cool</em>, but it is way more <em>convenient</em> to get compabitility with practically everything.
But, passthrough of USB peripherals to the WSL2 kernel has been missing for a while.</p>

<p>Fret not! The handsome looking fellas over at Microsoft has collaborated with <em>Frans van Dorsselaer</em>, famous for his <a href="https://github.com/dorssel/usbipd-win">usbipd-win</a>-project, which brings <em>USB over IP</em> -hosting capabilities to windows! By setting up the hosting of USB devices on the windows end, you can connect and mount them into your WSL-space, making everybody happy as can be!</p>

<h1 id="wsl-kernel-version-needs-to-be-lifted">WSL Kernel version needs to be lifted!</h1>

<p>The kernel needs to be <em>usbip</em>-aware in order to be aware of usbip. Previously it didn’t know it should be, so we need to help it out with that.</p>

<p>Read on about how to pull updates from MS if you are interested, but you <strong>most likely</strong> want to build the kernel yourself to get drivers anyway.</p>

<h2 id="do-i-need-to-win11-or-windows-update">Do I need to win11 or windows update??</h2>
<p>Fake news out there suggest that you need to upgrade to Win11 in order to make it work.
It even suggests that you need to use windows update in order to get it working.</p>

<p>Don’t panic! You can run <code class="language-bash highlighter-rouge">wsl <span class="nt">--update</span></code> to update your kernel to a new fancy version!
You should probably do this while the WSL host is not running. If you can’t figure out how to close them gracefully, bring out the killswitch with <code class="language-bash highlighter-rouge">wsl <span class="nt">--shutdown</span></code>. Docker doesn’t seem to always like this, but that’s not my problem ¯\_(ツ)_/¯</p>

<p>However this <em>might</em> require you to enable the <em>Receive updates for other Microsoft products when you update Windows</em> in Windows Update.</p>

<p>This cool fellow on Github wrote how to <a href="https://github.com/microsoft/WSL/issues/5650#issuecomment-765825503">Manually get the latest WSL2-kernel</a>. <strong>Thanks Mr. cool guy!</strong></p>

<p>Run <code class="language-bash highlighter-rouge"><span class="nb">uname</span> <span class="nt">-r</span></code> in WSL to get the current version of the kernel.</p>

<h2 id="just-build-the-kernel-yourself-its-not-scary">Just build the kernel yourself, it’s not scary</h2>

<p><em>But hey!</em> You are probably one of those noobs who want to be able to actually <em>use</em> the imported USB-devices!
In that case you might need to <a href="https://askubuntu.com/questions/1373910/ch340-serial-device-doesnt-appear-in-dev-wsl/">build the kernel</a> yourself in the end, with <strong>drivers</strong> either built directly into the kernel, or as <strong>runtime-loadable modules</strong>.
It’s pretty straightforward to do in WSL2 with the instructions in the linked post.</p>

<h1 id="usbipd-win">USBIPD-WIN</h1>

<p>OK, so now you have a new fancy updated kernel with USB-drivers. Fuck yeah, you are pretty cool!
Time to get this <code class="language-bash highlighter-rouge">usbipd-win</code>-ball rolling! Head over to the <a href="https://github.com/dorssel/usbipd-win/releases">usbipd-win releases</a>-page to download and install that shit!</p>

<h2 id="troubles-in-paradise">Troubles in paradise</h2>

<p>Before you go any further - Try running <code class="language-bash highlighter-rouge">reg query <span class="s2">"HKEY_LOCAL_MACHINE</span><span class="se">\S</span><span class="s2">YSTEM</span><span class="se">\C</span><span class="s2">urrentControlSet</span><span class="se">\C</span><span class="s2">ontrol</span><span class="se">\C</span><span class="s2">lass</span><span class="se">\{</span><span class="s2">36fc9e60-c465-11cf-8056-444553540000}"</span> /v UpperFilters</code>.</p>

<p>If you get any output from that registry key, you are <a href="https://github.com/dorssel/usbipd-win/issues/118">in for a bad time</a>.</p>

<p>It means something is trying to intercept and listen to the USB communication. For me it was <em>USBPcap</em> which I installed with the <em>Wireshark</em>-package.
But I’ve actually never used <em>USBPcap</em> so to solve problems I just uninstalled it. <strong>Yeet!</strong></p>

<p>A new version of usbipd-win is comming out that adds a <code class="language-bash highlighter-rouge"><span class="nt">--force</span></code>-flag to the <code class="language-bash highlighter-rouge">usbipd <span class="nb">bind</span></code> command which forces that to resolve itself, but at the cost of making the USB device <em>exclusive</em> to either (general purpose) Windows or usbipd. The normal <code class="language-bash highlighter-rouge">usbipd <span class="nb">bind</span></code>-command leaves it up to whoever attaches to the device first.</p>

<h3 id="share-thy-wealth">Share thy wealth</h3>
<p>Alright! Now we’re ready to go! Run <code class="language-bash highlighter-rouge">usbipd <span class="nb">bind</span> <span class="nt">--all</span></code> to expose everything!! Fuck security, fuck everything! (Actually be responsible though)</p>

<p>Hop over to WSL and run <code class="language-bash highlighter-rouge">usbip list <span class="nt">-r</span> &lt;your ip&gt;</code> to get a listing of what devices are exposed. If you can’t find <code class="language-bash highlighter-rouge">usbip</code>, follow the instructions at <a href="https://github.com/dorssel/usbipd-win/wiki/WSL-support#building-your-own-usbip-enabled-wsl-2-kernel">usbipd-win kernel building</a> to get <code class="language-bash highlighter-rouge">usbip</code>-commands that are guaranteed compatible with your machine and distro. You might also want to do the <code class="language-bash highlighter-rouge"><span class="nb">sudo </span>visudo</code>-part to update the secure path.</p>

<h1 id="let-wsl2-join-the-fun-or-usbip-in-wsl">Let WSL2 join the fun (or: <code class="language-bash highlighter-rouge">usbip</code> in <code class="language-bash highlighter-rouge">wsl</code>)</h1>
<p>Now we’re ready! You’ve done the <code class="language-bash highlighter-rouge">usbip list</code>-command in WSL and can see that there is stuff available from windows! Take note of the <strong>busid</strong> of the device you want to import, because you need to pass it to <code class="language-bash highlighter-rouge"><span class="nb">sudo </span>usbip attach <span class="nt">-r</span> &lt;your ip&gt; <span class="nt">--busid</span> &lt;busid&gt;</code>.</p>

<p>After you’ve done that, run <code class="language-bash highlighter-rouge">lsusb</code> to verify that it’s there. Next, run <code class="language-bash highlighter-rouge"><span class="nb">ls</span> <span class="nt">-al</span> /dev</code> to find that your device is now available!</p>

<h2 id="you-cant-access-that">You can’t access that!</h2>

<p>But wait, fuck! You probably also notice that the device in <code class="language-bash highlighter-rouge">/dev</code> is owned by <code class="language-bash highlighter-rouge">root</code> and nobody else has access to it! Crap!</p>

<p>That’s because the <code class="language-bash highlighter-rouge">udev</code>-service isn’t running. Manually kickstart it with <code class="language-bash highlighter-rouge"><span class="nb">sudo </span>service udev restart</code> and reattach your device.</p>

<h3 id="missing-udev-rules">Missing udev rules??</h3>
<p>Still fully owned by root?? Maybe you have the same problem I had! I had a Ubuntu18.04-distro which seemed to be missing the <code class="language-bash highlighter-rouge">udev</code> rule files. I did a distro-upgrade to 20.04 (because of other reasons) and they magically appeared. Thanks 20.04!</p>

<p>With the <code class="language-bash highlighter-rouge">udev</code>-rules in place and the <code class="language-bash highlighter-rouge">udev</code>-serive running, my device was properly exposed under <code class="language-bash highlighter-rouge">/dev/serial/by-<span class="k">*</span>/<span class="k">*</span></code>. Heck yeah! We’re pretty awesome by this stage!</p>

<h2 id="automate-wsl-udev-service-starting">Automate WSL <code class="language-bash highlighter-rouge">udev service</code> starting</h2>
<p>It’s a hassle to have to do the <code class="language-bash highlighter-rouge"><span class="nb">sudo </span>service restart udev</code> every time WSL is started though.</p>

<p>I adapted the solution from the <a href="https://github.com/microsoft/WSL/issues/4166#issuecomment-618159162">automatic filecache clearing</a>(which you probably also want to do to reclaim memory! Spent ~90 minutes reading through that and related threads, it boils down to linux using all available ram <em>which it doesn’t use *itself*</em> for file caching, but it doesn’t play well when there are others sharing that RAM. Oh well!)</p>

<p>Point 2&amp;3 from that link was thus adapted to kickstart <code class="language-bash highlighter-rouge">udev</code> when a WSL-bash is started.</p>

<ul>
  <li><code class="language-bash highlighter-rouge"><span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="si">$(</span>ps <span class="nt">-ef</span> | <span class="nb">grep </span>systemd-udevd | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nb">grep</span><span class="si">)</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>service udev restart &amp;&gt; /dev/null</code> in <code class="language-bash highlighter-rouge">~/.bashrs</code> to restart(more stable than starting it 🤔) if <code class="language-bash highlighter-rouge">udev</code> isn’t already running in WSL2</li>
  <li><code class="language-bash highlighter-rouge">%sudo <span class="nv">ALL</span><span class="o">=</span>NOPASSWD: /usr/sbin/service udev restart</code> added in <code class="language-bash highlighter-rouge"><span class="nb">sudo </span>visudo</code> to allow <code class="language-bash highlighter-rouge">.bashrc</code> (or well anyone) to actually do it.).</li>
</ul>

<p>You can verify with <code class="language-bash highlighter-rouge">dmesg</code> that stuff is recognized and attached by <code class="language-bash highlighter-rouge">udev</code> as you attach/dettach the device with <code class="language-bash highlighter-rouge">usbip</code>.</p>

<h1 id="the-promised-land">The promised land</h1>

<p>Finally! The perfect workflow!</p>

<p>Hah! Not quite yet! There’s more to this saga!</p>

<h2 id="automating-wsl-side-attaching">Automating WSL-side attaching</h2>
<p>Guess what’s very very irritating? When you’re doing some programming of a device and it restarts. That is often to be expected and part of the flashing workflow, but now you just lost the USB connection.</p>

<p>Guess you’ll just have to manually open a shell an reattach the device again…
Or! OR! You can spend a few hours writing some crap that does it for you, automatically!!</p>

<p>That’s what I did, and I’m very proud of my sucky solution, so much so that I’m going to share it with you, at no cost, free of charge. Yep, I’m a generous god. Use it at your own risk.</p>

<p>Credit where credit is due: This is a mutilated version of <a href="https://docs.microsoft.com/en-us/windows/win32/devio/registering-for-device-notification">Registering for device notification</a>, and the mutilation is probably not very healthy.</p>

<p>It uses a specific format of <code class="language-bash highlighter-rouge">device-&gt;dbcc_name</code> to extract VID&amp;PID-information, which on serial-port-detection (which happens in a pass immediately after) is sent to <code class="language-bash highlighter-rouge">attach.py</code> using <code class="language-bash highlighter-rouge">system<span class="o">()</span></code> 🤦‍♂️</p>

<p>Why pass it to python? It boils down to</p>

<ul>
  <li>String handling in c(++) sucks ass</li>
  <li>It’s easier to detect ip, wsl-location, and pass process arguments in python.</li>
</ul>

<p>Am I proud of it? Not at all! But this is a work-in-progress until auto-wsl-attach is available in <code class="language-bash highlighter-rouge">usbipd-win</code>. And it works <em>adequately</em>! My devices are instantly(well at least very speedily, &lt;1sec) exposed to within WSL, and there’s no stupid polling loop.</p>

<p>I started a <a href="https://github.com/dorssel/usbipd-win/discussions/168">auto-attach discussion</a> about doing it the proper way in <code class="language-bash highlighter-rouge">usbipd-win</code> and it seems it’s already in the backlog.</p>

<p>Build with <code class="language-bash highlighter-rouge">gcc main.cpp <span class="nt">-o</span> main.exe <span class="nt">-lole32</span></code>, or however you want to, I’m not your daddy, you can take care of yourself, I’m proud of you son.</p>

<p>The code is available on github, in the <a href="https://github.com/DrInfiniteExplorer/shitty_usbipd-win_wsl_autoattacher">shitty_usbipd-win_wsl_autoattacher</a> repo.</p>

<h3 id="c">C++</h3>

<p><details><summary>CLICK TO EXPAND C++ code for automation</summary></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
</pre></td><td class="rouge-code"><pre><span class="c1">// RegisterDeviceNotification.cpp</span>
<span class="cp">#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;
#include &lt;tchar.h&gt;
#include &lt;strsafe.h&gt;
#include &lt;dbt.h&gt;
</span>
<span class="c1">// This GUID is for all USB serial host PnP drivers, but you can replace it </span>
<span class="c1">// with any valid device class guid.</span>
<span class="n">GUID</span> <span class="n">WceusbshGUID</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x25dbce51</span><span class="p">,</span> <span class="mh">0x6c8f</span><span class="p">,</span> <span class="mh">0x4a72</span><span class="p">,</span>
                      <span class="mh">0x8a</span><span class="p">,</span><span class="mh">0x6d</span><span class="p">,</span><span class="mh">0xb5</span><span class="p">,</span><span class="mh">0x4c</span><span class="p">,</span><span class="mh">0x2b</span><span class="p">,</span><span class="mh">0x4f</span><span class="p">,</span><span class="mh">0xc8</span><span class="p">,</span><span class="mh">0x35</span> <span class="p">};</span>

<span class="c1">// For informational messages and window titles.</span>
<span class="n">PWSTR</span> <span class="n">g_pszAppName</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">OutputMessage</span><span class="p">(</span>
    <span class="n">HWND</span> <span class="n">hOutWnd</span><span class="p">,</span>
    <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span>
    <span class="n">LPARAM</span> <span class="n">lParam</span>
<span class="p">)</span>
<span class="c1">//     lParam  - String message to send to the window.</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Message: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">lParam</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ErrorHandler</span><span class="p">(</span>
    <span class="n">LPCTSTR</span> <span class="n">lpszFunction</span>
<span class="p">)</span>
<span class="p">{</span>

    <span class="n">LPVOID</span> <span class="n">lpMsgBuf</span><span class="p">;</span>
    <span class="n">LPVOID</span> <span class="n">lpDisplayBuf</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">dw</span> <span class="o">=</span> <span class="n">GetLastError</span><span class="p">();</span>

    <span class="n">FormatMessage</span><span class="p">(</span><span class="n">FORMAT_MESSAGE_ALLOCATE_BUFFER</span> <span class="o">|</span> <span class="n">FORMAT_MESSAGE_FROM_SYSTEM</span> <span class="o">|</span> <span class="n">FORMAT_MESSAGE_IGNORE_INSERTS</span><span class="p">,</span>
        <span class="nb">NULL</span><span class="p">,</span>
        <span class="n">dw</span><span class="p">,</span>
        <span class="n">MAKELANGID</span><span class="p">(</span><span class="n">LANG_NEUTRAL</span><span class="p">,</span> <span class="n">SUBLANG_DEFAULT</span><span class="p">),</span>
        <span class="p">(</span><span class="n">LPTSTR</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lpMsgBuf</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Error: %d - %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">lpMsgBuf</span><span class="p">);</span>
    <span class="n">LocalFree</span><span class="p">(</span><span class="n">lpMsgBuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="nf">DoRegisterDeviceInterfaceToHwnd</span><span class="p">(</span>
    <span class="n">IN</span> <span class="n">GUID</span> <span class="n">InterfaceClassGuid</span><span class="p">,</span>
    <span class="n">IN</span> <span class="n">HWND</span> <span class="n">hWnd</span><span class="p">,</span>
    <span class="n">OUT</span> <span class="n">HDEVNOTIFY</span><span class="o">*</span> <span class="n">hDeviceNotify</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">DEV_BROADCAST_DEVICEINTERFACE</span> <span class="n">NotificationFilter</span><span class="p">;</span>

    <span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NotificationFilter</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">NotificationFilter</span><span class="p">));</span>
    <span class="n">NotificationFilter</span><span class="p">.</span><span class="n">dbcc_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DEV_BROADCAST_DEVICEINTERFACE</span><span class="p">);</span>
    <span class="n">NotificationFilter</span><span class="p">.</span><span class="n">dbcc_devicetype</span> <span class="o">=</span> <span class="n">DBT_DEVTYP_DEVICEINTERFACE</span><span class="p">;</span>
    <span class="n">NotificationFilter</span><span class="p">.</span><span class="n">dbcc_classguid</span> <span class="o">=</span> <span class="n">InterfaceClassGuid</span><span class="p">;</span>

    <span class="o">*</span><span class="n">hDeviceNotify</span> <span class="o">=</span> <span class="n">RegisterDeviceNotification</span><span class="p">(</span>
        <span class="n">hWnd</span><span class="p">,</span>                       <span class="c1">// events recipient</span>
        <span class="o">&amp;</span><span class="n">NotificationFilter</span><span class="p">,</span>        <span class="c1">// type of device</span>
        <span class="n">DEVICE_NOTIFY_WINDOW_HANDLE</span> <span class="o">|</span> <span class="n">DEVICE_NOTIFY_ALL_INTERFACE_CLASSES</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="o">*</span><span class="n">hDeviceNotify</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ErrorHandler</span><span class="p">(</span><span class="s">"RegisterDeviceNotification"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">MessagePump</span><span class="p">(</span>
    <span class="n">HWND</span> <span class="n">hWnd</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">MSG</span> <span class="n">msg</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">retVal</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">((</span><span class="n">retVal</span> <span class="o">=</span> <span class="n">GetMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retVal</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ErrorHandler</span><span class="p">(</span><span class="s">"GetMessage"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">TranslateMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
            <span class="n">DispatchMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">startThing</span><span class="p">(</span><span class="kt">int</span> <span class="n">VID</span><span class="p">,</span> <span class="kt">int</span> <span class="n">PID</span><span class="p">)</span>
<span class="p">{</span>

    <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">5123</span><span class="p">];</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="s">"py attach.py %4x:%4x"</span><span class="p">,</span> <span class="n">VID</span><span class="p">,</span> <span class="n">PID</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Starting '%s'</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">INT_PTR</span> <span class="n">WINAPI</span> <span class="nf">WinProcCallback</span><span class="p">(</span>
    <span class="n">HWND</span> <span class="n">hWnd</span><span class="p">,</span>
    <span class="n">UINT</span> <span class="n">message</span><span class="p">,</span>
    <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span>
    <span class="n">LPARAM</span> <span class="n">lParam</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">LRESULT</span> <span class="n">lRet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">HDEVNOTIFY</span> <span class="n">hDeviceNotify</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">HWND</span> <span class="n">hEditWnd</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">ULONGLONG</span> <span class="n">msgCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">WM_CREATE</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DoRegisterDeviceInterfaceToHwnd</span><span class="p">(</span>
            <span class="n">WceusbshGUID</span><span class="p">,</span>
            <span class="n">hWnd</span><span class="p">,</span>
            <span class="o">&amp;</span><span class="n">hDeviceNotify</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">// Terminate on failure.</span>
            <span class="n">ErrorHandler</span><span class="p">(</span><span class="s">"DoRegisterDeviceInterfaceToHwnd"</span><span class="p">);</span>
            <span class="n">ExitProcess</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">WM_DEVICECHANGE</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="c1">//</span>
        <span class="c1">// This is the actual message from the interface via Windows messaging.</span>
        <span class="c1">// This code includes some additional decoding for this particular device type</span>
        <span class="c1">// and some common validation checks.</span>
        <span class="c1">//</span>
        <span class="c1">// Note that not all devices utilize these optional parameters in the same</span>
        <span class="c1">// way. Refer to the extended information for your particular device type </span>
        <span class="c1">// specified by your GUID.</span>
        <span class="c1">//</span>
        <span class="n">PDEV_BROADCAST_DEVICEINTERFACE</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDEV_BROADCAST_DEVICEINTERFACE</span><span class="p">)</span><span class="n">lParam</span><span class="p">;</span>
        <span class="n">TCHAR</span> <span class="n">strBuff</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

        <span class="c1">// Output some messages to the window.</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">wParam</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="k">case</span> <span class="n">DBT_DEVICEARRIVAL</span><span class="p">:</span>
            <span class="n">msgCount</span><span class="o">++</span><span class="p">;</span>
            <span class="n">StringCchPrintf</span><span class="p">(</span>
                <span class="n">strBuff</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
                <span class="n">TEXT</span><span class="p">(</span><span class="s">"Message %d: DBT_DEVICEARRIVAL</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">msgCount</span><span class="p">);</span>
            
            <span class="p">{</span>
                <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"OEM"</span><span class="p">,</span> <span class="s">"???"</span><span class="p">,</span> <span class="s">"VOLUME"</span><span class="p">,</span> <span class="s">"PORT"</span><span class="p">,</span> <span class="s">"???"</span><span class="p">,</span> <span class="s">"DEVICEINTERFACE"</span><span class="p">,</span> <span class="s">"HANDLE"</span><span class="p">};</span>

                <span class="k">const</span> <span class="k">auto</span><span class="o">*</span> <span class="n">dev</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">DEV_BROADCAST_HDR</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">lParam</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"Type: %d - %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dbch_devicetype</span><span class="p">,</span> <span class="n">types</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dbch_devicetype</span><span class="p">]);</span>

                <span class="k">static</span> <span class="kt">int</span> <span class="n">VID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="k">static</span> <span class="kt">int</span> <span class="n">PID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dbch_devicetype</span> <span class="o">==</span> <span class="n">DBT_DEVTYP_DEVICEINTERFACE</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">const</span> <span class="k">auto</span><span class="o">*</span> <span class="n">device</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DEV_BROADCAST_DEVICEINTERFACE</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                    <span class="kt">wchar_t</span> <span class="n">guidStringBuffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
                    <span class="n">StringFromGUID2</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dbcc_classguid</span><span class="p">,</span> <span class="n">guidStringBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">guidStringBuffer</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">guidStringBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"Device guid: %S</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">guidStringBuffer</span><span class="p">);</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"Device name: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dbcc_name</span><span class="p">);</span>

                    <span class="c1">// \\?\USB#VID_1A86&amp;PID_7523#5&amp;521a615&amp;0&amp;9                    </span>
                    <span class="k">const</span> <span class="kt">bool</span> <span class="n">longEnough</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dbcc_name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">25</span><span class="p">;</span>
                    <span class="k">const</span> <span class="kt">bool</span> <span class="n">startsOk</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dbcc_name</span> <span class="o">==</span> <span class="n">strstr</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dbcc_name</span><span class="p">,</span> <span class="s">"</span><span class="se">\\\\</span><span class="s">?</span><span class="se">\\</span><span class="s">USB#VID_"</span><span class="p">);</span>
                    <span class="k">auto</span> <span class="n">ampPIDOffset</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dbcc_name</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">longEnough</span><span class="p">;</span>
                    <span class="k">const</span> <span class="kt">bool</span> <span class="n">continuesOk</span> <span class="o">=</span> <span class="n">ampPIDOffset</span> <span class="o">==</span> <span class="n">strstr</span><span class="p">(</span><span class="n">ampPIDOffset</span><span class="p">,</span> <span class="s">"&amp;PID_"</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">startsOk</span> <span class="o">&amp;&amp;</span> <span class="n">continuesOk</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="kt">char</span> <span class="n">vid</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">pid</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

                        <span class="n">memcpy</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dbcc_name</span><span class="o">+</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
                        <span class="n">memcpy</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">dbcc_name</span><span class="o">+</span><span class="mi">21</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
                        <span class="n">vid</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="n">VID</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strtol</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
                        <span class="n">PID</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strtol</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

                        <span class="n">printf</span><span class="p">(</span><span class="s">"GOT YOU NOW %04x:%04x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">VID</span><span class="p">,</span> <span class="n">PID</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dbch_devicetype</span> <span class="o">==</span> <span class="n">DBT_DEVTYP_PORT</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">const</span> <span class="k">auto</span><span class="o">*</span> <span class="n">port</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DEV_BROADCAST_PORT</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"Port name: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dbcp_name</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">VID</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">PID</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">startThing</span><span class="p">(</span><span class="n">VID</span><span class="p">,</span><span class="n">PID</span><span class="p">);</span>
                        <span class="n">VID</span> <span class="o">=</span> <span class="n">PID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                
            <span class="p">}</span>

            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">DBT_DEVICEREMOVECOMPLETE</span><span class="p">:</span>
            <span class="n">msgCount</span><span class="o">++</span><span class="p">;</span>
            <span class="n">StringCchPrintf</span><span class="p">(</span>
                <span class="n">strBuff</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
                <span class="n">TEXT</span><span class="p">(</span><span class="s">"Message %d: DBT_DEVICEREMOVECOMPLETE</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">msgCount</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">DBT_DEVNODES_CHANGED</span><span class="p">:</span>
            <span class="n">msgCount</span><span class="o">++</span><span class="p">;</span>
            <span class="n">StringCchPrintf</span><span class="p">(</span>
                <span class="n">strBuff</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
                <span class="n">TEXT</span><span class="p">(</span><span class="s">"Message %d: DBT_DEVNODES_CHANGED</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">msgCount</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
            <span class="n">msgCount</span><span class="o">++</span><span class="p">;</span>
            <span class="n">StringCchPrintf</span><span class="p">(</span>
                <span class="n">strBuff</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
                <span class="n">TEXT</span><span class="p">(</span><span class="s">"Message %d: WM_DEVICECHANGE message received, value %d unhandled.</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span>
                <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">msgCount</span><span class="p">,</span> <span class="n">wParam</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">OutputMessage</span><span class="p">(</span><span class="n">hEditWnd</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="p">(</span><span class="n">LPARAM</span><span class="p">)</span><span class="n">strBuff</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">WM_CLOSE</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">UnregisterDeviceNotification</span><span class="p">(</span><span class="n">hDeviceNotify</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">ErrorHandler</span><span class="p">(</span><span class="s">"UnregisterDeviceNotification"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">DestroyWindow</span><span class="p">(</span><span class="n">hWnd</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">WM_DESTROY</span><span class="p">:</span>
        <span class="n">PostQuitMessage</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
        <span class="c1">// Send all other messages on to the default windows handler.</span>
        <span class="n">lRet</span> <span class="o">=</span> <span class="n">DefWindowProc</span><span class="p">(</span><span class="n">hWnd</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">lParam</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">lRet</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WND_CLASS_NAME TEXT("Usbipd-win-wsl-autoattach")
</span>
<span class="n">BOOL</span> <span class="nf">InitWindowClass</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">WNDCLASSEX</span> <span class="n">wndClass</span><span class="p">;</span>

    <span class="n">wndClass</span><span class="p">.</span><span class="n">cbSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WNDCLASSEX</span><span class="p">);</span>
    <span class="n">wndClass</span><span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">CS_OWNDC</span> <span class="o">|</span> <span class="n">CS_HREDRAW</span> <span class="o">|</span> <span class="n">CS_VREDRAW</span><span class="p">;</span>
    <span class="n">wndClass</span><span class="p">.</span><span class="n">hInstance</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">HINSTANCE</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="n">wndClass</span><span class="p">.</span><span class="n">lpfnWndProc</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">WNDPROC</span><span class="o">&gt;</span><span class="p">(</span><span class="n">WinProcCallback</span><span class="p">);</span>
    <span class="n">wndClass</span><span class="p">.</span><span class="n">cbClsExtra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">wndClass</span><span class="p">.</span><span class="n">cbWndExtra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">wndClass</span><span class="p">.</span><span class="n">hIcon</span> <span class="o">=</span> <span class="n">LoadIcon</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IDI_APPLICATION</span><span class="p">);</span>
    <span class="n">wndClass</span><span class="p">.</span><span class="n">hbrBackground</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//CreateSolidBrush(RGB(192, 192, 192));</span>
    <span class="n">wndClass</span><span class="p">.</span><span class="n">hCursor</span> <span class="o">=</span> <span class="n">LoadCursor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IDC_ARROW</span><span class="p">);</span>
    <span class="n">wndClass</span><span class="p">.</span><span class="n">lpszClassName</span> <span class="o">=</span> <span class="n">WND_CLASS_NAME</span><span class="p">;</span>
    <span class="n">wndClass</span><span class="p">.</span><span class="n">lpszMenuName</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">wndClass</span><span class="p">.</span><span class="n">hIconSm</span> <span class="o">=</span> <span class="n">wndClass</span><span class="p">.</span><span class="n">hIcon</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RegisterClassEx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wndClass</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">ErrorHandler</span><span class="p">(</span><span class="s">"RegisterClassEx"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="kr">__stdcall</span> <span class="nf">_tWinMain</span><span class="p">(</span>
    <span class="n">_In_</span> <span class="n">HINSTANCE</span> <span class="n">hInstanceExe</span><span class="p">,</span>
    <span class="n">_In_opt_</span> <span class="n">HINSTANCE</span><span class="p">,</span> <span class="c1">// should not reference this parameter</span>
    <span class="n">_In_</span> <span class="n">PTSTR</span> <span class="n">lpstrCmdLine</span><span class="p">,</span>
    <span class="n">_In_</span> <span class="kt">int</span> <span class="n">nCmdShow</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">InitWindowClass</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">HWND</span> <span class="n">hWnd</span> <span class="o">=</span> <span class="n">CreateWindowEx</span><span class="p">(</span>
        <span class="n">WS_EX_CLIENTEDGE</span> <span class="o">|</span> <span class="n">WS_EX_APPWINDOW</span><span class="p">,</span>
        <span class="n">WND_CLASS_NAME</span><span class="p">,</span>
        <span class="s">"Yolo boi"</span><span class="p">,</span>
        <span class="n">WS_OVERLAPPEDWINDOW</span><span class="p">,</span> <span class="c1">// style</span>
        <span class="n">CW_USEDEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
        <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
        <span class="n">hInstanceExe</span><span class="p">,</span>
        <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">hWnd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ErrorHandler</span><span class="p">(</span><span class="s">"CreateWindowEx: main appwindow hWnd"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//ShowWindow(hWnd, SW_SHOWNORMAL);</span>
    <span class="n">UpdateWindow</span><span class="p">(</span><span class="n">hWnd</span><span class="p">);</span>

    <span class="n">MessagePump</span><span class="p">(</span><span class="n">hWnd</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p></details></p>

<h3 id="python3">Python3</h3>

<p><details><summary>CLICK TO EXPAND Python3 code.</summary></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>

  <span class="nb">id</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">ip</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostbyname_ex</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">gethostname</span><span class="p">())[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">usbip</span> <span class="o">=</span> <span class="s">"/usr/lib/linux-tools/5.4.0-77-generic/usbip"</span>

  <span class="n">get_busid_cmd</span> <span class="o">=</span> <span class="s">f"</span><span class="si">{</span><span class="n">usbip</span><span class="si">}</span><span class="s"> list -r </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s"> | grep </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s"> | cut -f 1 -d : | awk '{{$1=$1;print}}'"</span>
  <span class="n">attach_cmd</span> <span class="o">=</span> <span class="s">f"</span><span class="si">{</span><span class="n">usbip</span><span class="si">}</span><span class="s"> attach -r </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s"> --busid $(</span><span class="si">{</span><span class="n">get_busid_cmd</span><span class="si">}</span><span class="s">)"</span>
  <span class="k">print</span><span class="p">(</span><span class="n">get_busid_cmd</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="n">attach_cmd</span><span class="p">)</span>


  <span class="n">is32bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">platform</span><span class="p">.</span><span class="n">architecture</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">'32bit'</span><span class="p">)</span>
  <span class="n">system32</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'SystemRoot'</span><span class="p">],</span> <span class="s">'SysNative'</span> <span class="k">if</span> <span class="n">is32bit</span> <span class="k">else</span> <span class="s">'System32'</span><span class="p">)</span>
  <span class="n">wsl</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">system32</span><span class="p">,</span> <span class="s">'wsl.exe'</span><span class="p">)</span>

  <span class="n">wsl_cmd</span> <span class="o">=</span> <span class="s">f'</span><span class="si">{</span><span class="n">wsl</span><span class="si">}</span><span class="s"> -e /bin/bash -c'</span>
  <span class="k">print</span><span class="p">(</span><span class="n">wsl_cmd</span><span class="p">)</span>

  <span class="n">split_cmd</span> <span class="o">=</span> <span class="n">wsl_cmd</span><span class="p">.</span><span class="n">split</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s">f"sudo </span><span class="si">{</span><span class="n">attach_cmd</span><span class="si">}</span><span class="s">"</span><span class="p">]</span>
  <span class="k">print</span><span class="p">(</span><span class="n">split_cmd</span><span class="p">)</span>

  <span class="n">subprocess</span><span class="p">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">split_cmd</span><span class="p">)</span>
  <span class="k">return</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
  <span class="n">main</span><span class="p">()</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p></details></p>

<p>What am I going to do with this? Program some AVRs and nanos and STM32s and ESPs, and of course I’m going to run a <a href="https://github.com/mkuf/prind">prind stack</a> inside WSL2 now that I can! Hah, can’t trick me into buying expensive raspberries now that there are no more <em>Zero W2</em> on the market 😭</p>


</div>

<div class="">
      


    <b>Links in this post:</b>
    <ul>
    
    <li><a href="https://github.com/dorssel/usbipd-win">usbipd-win</a></li>
    
    <li><a href="https://github.com/microsoft/WSL/issues/5650#issuecomment-765825503">Manually get the latest WSL2-kernel</a></li>
    
    <li><a href="https://askubuntu.com/questions/1373910/ch340-serial-device-doesnt-appear-in-dev-wsl/">build the kernel</a></li>
    
    <li><a href="https://github.com/dorssel/usbipd-win/releases">usbipd-win releases</a></li>
    
    <li><a href="https://github.com/dorssel/usbipd-win/issues/118">in for a bad time</a></li>
    
    <li><a href="https://github.com/dorssel/usbipd-win/wiki/WSL-support#building-your-own-usbip-enabled-wsl-2-kernel">usbipd-win kernel building</a></li>
    
    <li><a href="https://github.com/microsoft/WSL/issues/4166#issuecomment-618159162">automatic filecache clearing</a></li>
    
    <li><a href="https://docs.microsoft.com/en-us/windows/win32/devio/registering-for-device-notification">Registering for device notification</a></li>
    
    <li><a href="https://github.com/dorssel/usbipd-win/discussions/168">auto-attach discussion</a></li>
    
    <li><a href="https://github.com/DrInfiniteExplorer/shitty_usbipd-win_wsl_autoattacher">shitty_usbipd-win_wsl_autoattacher</a></li>
    
    <li><a href="https://github.com/mkuf/prind">prind stack</a></li>
    
    </ul>
</div>



  

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://blog.luben.se/2021/12/18/wsl-serials.html';
      this.page.identifier = 'https://blog.luben.se/2021/12/18/wsl-serials.html';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://siffer.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


                </div>
                
                <div class="column is-4-desktop is-12-tablet">
                    <p class="title is-4">Latest Posts</p>

<div class="columns is-multiline">
    
    <div class="column is-12">
        <div class="card">
    
    <header class="card-header">
        <a class="card-header-title" href="/2021/12/18/wsl-serials.html">WSL2 & USB Serials</a>
        <footer class="card-footer">
            <nobr>
                <p class="card-footer-item">Published:&nbsp;<a href="https://en.wikipedia.org/wiki/ISO_8601" alt="ISO-8601 for the win" style="color: inherit;text-decoration: inherit">2021-12-18</a></p>
            </nobr>
        </footer>
    </header>
    
    <div class="card-content">
        <div class="content">
            
            <p><p>Yo yo! USB &amp; USB-serials in WSL? Read more!</p>

</p>
        </div>
    </div>
</div>
    </div>
    
    <div class="column is-12">
        <div class="card">
    
    <header class="card-header">
        <a class="card-header-title" href="/2020/11/21/bed-level-script.html">Bed level script</a>
        <footer class="card-footer">
            <nobr>
                <p class="card-footer-item">Published:&nbsp;<a href="https://en.wikipedia.org/wiki/ISO_8601" alt="ISO-8601 for the win" style="color: inherit;text-decoration: inherit">2020-11-21</a></p>
            </nobr>
        </footer>
    </header>
    
    <div class="card-content">
        <div class="content">
            
            <p><p>I’ve written a tool to adjust bed-level-data easier.</p>

</p>
        </div>
    </div>
</div>
    </div>
    
    <div class="column is-12">
        <div class="card">
    
    <header class="card-header">
        <a class="card-header-title" href="/2020/11/07/ender5-pro-firmware.html">Building & flashing Ender5 Pro firmware</a>
        <footer class="card-footer">
            <nobr>
                <p class="card-footer-item">Published:&nbsp;<a href="https://en.wikipedia.org/wiki/ISO_8601" alt="ISO-8601 for the win" style="color: inherit;text-decoration: inherit">2020-11-07</a></p>
            </nobr>
        </footer>
    </header>
    
    <div class="card-content">
        <div class="content">
            
            <p><p>So I went and bought and Ender5 Pro to learn how to 3d-print stuff.</p>

</p>
        </div>
    </div>
</div>
    </div>
    
</div>

                </div>
                
            </div>
        </div>
    </section>
    
        <footer class="footer">
    <div class="container">
        
        
    </div>
</footer>

    
    <script src="/assets/js/app.js" type="text/javascript"></script><!-- footer scripts --></body>
</html>